<template>
	<div class="p-6">
		<RenderedForm
			v-if="input.files"
			v-model:values="input"
			empty-value=""
			:form="workflowForm"
			:saving="updateAction.isApplying"
			@update:values="updateAction.trigger(inputSource, input)"
		/>
	</div>
</template>
<script setup lang="ts">
import { InputSource } from "@/components/Modules/InputSources/input-sources";
import { getAction } from "@/components/Modules/InputSources/inputSourceActions";
import { MultiFileField, RenderedForm, TextField } from "quasar-ui-danx";
import { Form } from "quasar-ui-danx/types";
import { h, ref, watch } from "vue";

const props = defineProps<{
	inputSource: InputSource,
}>();

const updateAction = getAction("update-debounced");
const input = ref({
	name: props.inputSource.name,
	description: props.inputSource.description,
	files: props.inputSource.files
});

// Load the files if they have been loaded after the component is mounted
watch(() => props.inputSource.files, () => {
	if (!input.value.files) {
		input.value.files = props.inputSource.files;
	}
});

const workflowForm: Form = {
	fields: [
		{
			name: "name",
			vnode: (props) => h(TextField, { ...props, maxLength: 40 }),
			label: "Name",
			required: true
		},
		{
			name: "description",
			vnode: (props) => h(TextField, { ...props, type: "textarea", inputClass: "h-56", maxLength: 512 }),
			label: "Description"
		},
		{
			name: "files",
			vnode: (props) => h(MultiFileField, { ...props }),
			label: "Files"
		}
	]
};
</script>
